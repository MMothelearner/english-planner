import streamlit as st
from openai import OpenAI

# --- 1. é…ç½®é¡µé¢ ---
st.set_page_config(page_title="AI è‹±è¯­ç§æ•™ Pro (V2.0)", layout="centered")

# --- 2. è·å– API Key ---
api_key = st.secrets.get("DEEPSEEK_API_KEY")

if api_key:
    client = OpenAI(
        api_key=api_key,
        base_url="https://api.deepseek.com"
    )
else:
    client = None

# ==========================================
# ğŸ’ æ ¸å¿ƒèµ„äº§ï¼šæ‚¨çš„ç‹¬å®¶èµ„æºåº“ (çŸ¥è¯†åº“)
# ==========================================
# è¿™é‡Œçš„æ–‡å­—å°±æ˜¯ AI çš„â€œå¤–æŒ‚å¤§è„‘â€ã€‚
# æ‚¨å¯ä»¥éšæ—¶å›æ¥ä¿®æ”¹è¿™é‡Œçš„å†…å®¹ï¼Œæ¢æˆæ‚¨çš„ç§æœ‰æ•™æã€‚
MY_SECRET_DB = """
ã€ç‹ç‰Œæ•™æåº“ã€‘
1. ã€ŠRAZåˆ†çº§é˜…è¯»ã€‹(Reading A-Z)
   - é€‚åˆäººç¾¤ï¼šåˆ·è¯æ±‡é‡ã€é›¶åŸºç¡€åˆ°é«˜é˜¶é€šåƒï¼Œå°¤å…¶é€‚åˆæ—¶é—´å……è£•çš„å®¶åº­ã€‚
   - å–ç‚¹ï¼šä½“ç³»æœ€åºå¤§ï¼Œèºæ—‹ä¸Šå‡ï¼Œéè™šæ„å†…å®¹ä¸°å¯Œã€‚
2. ã€Šç‰›æ´¥é˜…è¯»æ ‘ã€‹(Oxford Reading Tree)
   - é€‚åˆäººç¾¤ï¼šå–œæ¬¢æ•…äº‹ã€éœ€è¦è¶£å‘³æ€§å¯è’™çš„å¹¼å„¿å›­/ä½å¹´çº§å­©å­ã€‚
   - å–ç‚¹ï¼šBiff, Chip & Kipper ä¸€å®¶äººçš„æ•…äº‹ï¼Œè‹±å¼å¹½é»˜ï¼Œå­©å­ä¸æ’æ–¥ã€‚
3. ã€ŠNational Geographic Learningã€‹(å›½å®¶åœ°ç†)
   - é€‚åˆäººç¾¤ï¼šå›½é™…æ ¡ã€å‡†å¤‡è€ƒå°æ‰˜ç¦/æ‰˜ç¦çš„ç‰›å¨ƒã€‚
   - å–ç‚¹ï¼šå›¾ç‰‡ç²¾ç¾ï¼Œæå‡ä¸–ç•Œè§‚ï¼Œå­¦æœ¯è¯æ±‡ä¸°å¯Œã€‚
4. ã€ŠPhonics Kidsã€‹(è‡ªç„¶æ‹¼è¯»)
   - é€‚åˆäººç¾¤ï¼šåˆšå¼€å§‹è®¤å­—ã€æ ¡å†…è‹±è¯­è·Ÿä¸ä¸Šçš„å°å­¦ç”Ÿã€‚
   - å–ç‚¹ï¼šè§†é¢‘+ä¹¦ç»“åˆï¼Œè§è¯èƒ½è¯»ï¼Œè§£å†³èƒŒå•è¯éš¾çš„é—®é¢˜ã€‚

ã€æ¨è APP/å·¥å…·ã€‘
1. ä¼´é±¼ç»˜æœ¬ / æ­¥æ­¥é˜…è¯» (é€‚åˆé…åˆ RAZ ä½¿ç”¨)
2. Starfall (é€‚åˆé›¶åŸºç¡€å­—æ¯å¯è’™)
3. è‹±è¯­è¶£é…éŸ³ (é€‚åˆä¸æ•¢å¼€å£çš„å­©å­)

ã€ç‹¬å®¶æ•™å­¦å¿ƒæ³•ã€‘(AI ä¼šæ¨¡ä»¿è¿™äº›è¯æœ¯)
1. "å¬åŠ›å…ˆè¡Œ"ï¼šåœ¨å­©å­èƒ½å¬æ‡‚ 1000 ä¸ªå•è¯ä¹‹å‰ï¼Œä¸è¦é€¼ä»–é»˜å†™å•è¯ã€‚
2. "ä¸‰æ˜æ²»èµç¾æ³•"ï¼šæŒ‡å‡ºé”™è¯¯å‰å…ˆå¤¸å¥–ï¼ŒæŒ‡å‡ºé”™è¯¯åå†é¼“åŠ±ï¼Œä¸è¦æ‰“å‡»è‡ªä¿¡ã€‚
3. "äºŒå…«å®šå¾‹"ï¼š80% çš„æ—¶é—´æ³›å¬ç£¨è€³æœµï¼Œ20% çš„æ—¶é—´ç²¾è¯»å­¦è§„åˆ™ã€‚
"""

# ==========================================
# ä¾§è¾¹æ 
# ==========================================
st.sidebar.markdown("### ğŸ“‹ å­¦ç”Ÿæ¡£æ¡ˆå½•å…¥")
age = st.sidebar.number_input("1. å­©å­å¹´é¾„", 2, 15, 6)
school_stage = st.sidebar.radio("2.å°±è¯»å­¦æ®µ", ("å¹¼å„¿å›­ (æ—¶é—´å……è£•)", "å°å­¦ (æ—¶é—´ç´§å¼ )"))

history_options = {
    "zero": "å®Œå…¨é›¶åŸºç¡€ï¼Œæ²¡æ¥è§¦è¿‡",
    "basic_home": "å®¶é‡Œéšä¾¿å­¦è¿‡ä¸€ç‚¹å•è¯",
    "intl_silent": "å›½é™…å›­ï¼Œå¬å¾—æ‡‚ä½†ä¸æ•¢è¯´",
    "primary_struggle": "æ ¡å†…è‹±è¯­è·Ÿä¸ä¸Šï¼Œæ’æ–¥",
    "ket_pass": "KETå·²è¿‡ï¼Œæƒ³å†²åˆºPET/å“è¶Š",
    "toefl_jr": "ç‰›å¨ƒï¼Œå‡†å¤‡è€ƒå°æ‰˜ç¦"
}
status_key = st.sidebar.selectbox("3. è‹±è¯­ç°çŠ¶", options=list(history_options.keys()), format_func=lambda x: history_options[x])
status_desc = history_options[status_key]

generate_btn = st.sidebar.button("âœ¨ ç”Ÿæˆä¸“å®¶æ–¹æ¡ˆ (V2.0)", type="primary")

# ==========================================
# æ ¸å¿ƒé€»è¾‘ (Prompt Injection)
# ==========================================
system_prompt = f"""
ä½ æ˜¯ä¸€ä½èµ„æ·±è‹±è¯­æ•™ç ”ä¸»ç®¡ã€‚
ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®ç”¨æˆ·çš„è¾“å…¥ï¼Œç”Ÿæˆä¸€ä»½ã€Šè‹±è¯­å­¦ä¹ è§„åˆ’ä¹¦ã€‹ã€‚

âš ï¸ **æœ€é‡è¦çš„è§„åˆ™ (èµ„æºé™åˆ¶)ï¼š**
**åœ¨æ¨èæ•™æã€APP æˆ–å¼•ç”¨æ•™å­¦ç†å¿µæ—¶ï¼Œè¯·ä¼˜å…ˆä»ä¸‹é¢çš„ã€ç‹¬å®¶èµ„æºåº“ã€‘ä¸­é€‰æ‹©ã€‚**
**ä¸è¦æ¨èã€ç‹¬å®¶èµ„æºåº“ã€‘ä»¥å¤–çš„é™Œç”Ÿæ•™æï¼Œé™¤éåº“é‡Œçš„èµ„æºå®Œå…¨æ— æ³•åŒ¹é…ã€‚**

---
ã€ç‹¬å®¶èµ„æºåº“å†…å®¹å¼€å§‹ã€‘
{MY_SECRET_DB}
ã€ç‹¬å®¶èµ„æºåº“å†…å®¹ç»“æŸã€‘
---

**è¾“å‡ºç»“æ„è¦æ±‚ (Markdown)ï¼š**
1. **æ·±åº¦è¯Šæ–­**ï¼šåŸºäºäºŒè¯­ä¹ å¾—ç†è®ºåˆ†æç—›ç‚¹ã€‚
2. **æ ¸å¿ƒç­–ç•¥**ï¼šç”¨ä¸€ä¸ªä¸“ä¸šæœ¯è¯­æ¦‚æ‹¬ã€‚
3. **èµ„æºåŒ¹é…**ï¼šä»æˆ‘çš„èµ„æºåº“ä¸­æŒ‘é€‰ 2 æœ¬ä¹¦ + 1 ä¸ª APPï¼Œå¹¶è¯´æ˜*ä¸ºä»€ä¹ˆ*é€‰å®ƒä»¬ã€‚
4. **å‘¨è®¡åˆ’è¡¨**ï¼šå…·ä½“çš„æ¯æ—¥å®‰æ’ã€‚
5. **ä¸“å®¶é”¦å›Š**ï¼šå¼•ç”¨ä¸€æ¡æˆ‘çš„ã€ç‹¬å®¶æ•™å­¦å¿ƒæ³•ã€‘ç»™å®¶é•¿å»ºè®®ã€‚

è¯­æ°”è¦æ±‚ï¼šä¸“ä¸šã€è‡ªä¿¡ã€æœ‰åŒç†å¿ƒã€‚
"""

# ==========================================
# ä¸»ç•Œé¢
# ==========================================
st.title("ğŸ“ AI è‹±è¯­ç§æ•™è§„åˆ’ä¹¦ V2.0")
st.caption("Powered by DeepSeek-V3 | æ¤å…¥ç‹¬å®¶æ•™ç ”åº“")
st.markdown("---")

if generate_btn:
    if not client:
        st.error("âš ï¸ æœªé…ç½® API Keyï¼Œè¯·å»åå° Settings -> Secrets é…ç½®ã€‚")
    else:
        user_prompt = f"å­¦ç”Ÿæ¡£æ¡ˆï¼šå¹´é¾„{age}å²ï¼Œå­¦æ®µ{school_stage}ï¼Œç°çŠ¶ï¼š{status_desc}ã€‚è¯·ç”Ÿæˆè§„åˆ’ã€‚"
        
        with st.spinner("ğŸ§  æ­£åœ¨æ£€ç´¢ç‹¬å®¶èµ„æºåº“ï¼Œç”Ÿæˆæ–¹æ¡ˆä¸­..."):
            try:
                response = client.chat.completions.create(
                    model="deepseek-chat",
                    messages=[
                        {"role": "system", "content": system_prompt},
                        {"role": "user", "content": user_prompt},
                    ],
                    temperature=1.2,
                    stream=False
                )
                st.markdown(response.choices[0].message.content)
                st.success("âœ… åŸºäºç‹¬å®¶èµ„æºåº“çš„æ–¹æ¡ˆå·²ç”Ÿæˆï¼")
                
            except Exception as e:
                st.error(f"å‡ºé”™å•¦ï¼š{e}")
                if "402" in str(e):
                    st.error("ğŸ’¡ å¯èƒ½æ˜¯ DeepSeek ä½™é¢ä¸è¶³ï¼Œè¯·å»å®˜ç½‘å……å€¼ 10 å…ƒã€‚")

else:
    st.info("ğŸ‘ˆ è¯·åœ¨å·¦ä¾§è°ƒæ•´å­¦ç”Ÿæ¡£æ¡ˆï¼Œä½“éªŒ V2.0 ç‰ˆæœ¬çš„ç²¾å‡†æ¨èã€‚")
