import streamlit as st
from openai import OpenAI # DeepSeek å…¼å®¹ OpenAI çš„åº“

# --- 1. é…ç½®é¡µé¢ ---
st.set_page_config(page_title="AI è‹±è¯­ç§æ•™ Pro", layout="centered")

# --- 2. è·å– API Key (ä»äº‘ç«¯å®‰å…¨æŸœ) ---
# æ³¨æ„ï¼šåœ¨æœ¬åœ°è¿è¡Œæ—¶ï¼Œå¦‚æœæ²¡æœ‰é…ç½® secrets.tomlï¼Œè¿™æ®µå¯èƒ½ä¼šæŠ¥é”™ã€‚
# å»ºè®®å…ˆç›´æ¥åœ¨äº‘ç«¯éƒ¨ç½²æŸ¥çœ‹æ•ˆæœï¼Œæˆ–è€…åœ¨æœ¬åœ°åˆ›å»ºä¸€ä¸ª .streamlit/secrets.toml æ–‡ä»¶
api_key = st.secrets.get("DEEPSEEK_API_KEY")

# åˆå§‹åŒ– DeepSeek å®¢æˆ·ç«¯
if api_key:
    client = OpenAI(
        api_key=api_key,
        base_url="https://api.deepseek.com" # è¿™é‡ŒæŒ‡å‘ DeepSeek çš„æœåŠ¡å™¨
    )
else:
    client = None

# --- 3. ä¾§è¾¹æ ï¼šæ¡£æ¡ˆå½•å…¥ ---
st.sidebar.markdown("### ğŸ“‹ å­¦ç”Ÿæ¡£æ¡ˆå½•å…¥")

age = st.sidebar.number_input("1. å­©å­å¹´é¾„", 2, 15, 6)
school_stage = st.sidebar.radio("2.å°±è¯»å­¦æ®µ", ("å¹¼å„¿å›­ (æ—¶é—´å……è£•)", "å°å­¦ (æ—¶é—´ç´§å¼ )"))

history_options = {
    "zero": "å®Œå…¨é›¶åŸºç¡€ï¼Œæ²¡æ¥è§¦è¿‡",
    "basic_home": "å®¶é‡Œéšä¾¿å­¦è¿‡ä¸€ç‚¹å•è¯",
    "intl_silent": "å›½é™…å›­ï¼Œå¬å¾—æ‡‚ä½†ä¸æ•¢è¯´",
    "primary_struggle": "æ ¡å†…è‹±è¯­è·Ÿä¸ä¸Šï¼Œæ’æ–¥",
    "ket_pass": "KETå·²è¿‡ï¼Œæƒ³å†²åˆºPET/å“è¶Š",
    "toefl_jr": "ç‰›å¨ƒï¼Œå‡†å¤‡è€ƒå°æ‰˜ç¦"
}
status_key = st.sidebar.selectbox("3. è‹±è¯­ç°çŠ¶", options=list(history_options.keys()), format_func=lambda x: history_options[x])
status_desc = history_options[status_key] # è·å–ä¸­æ–‡æè¿°

generate_btn = st.sidebar.button("âœ¨ å‘¼å« AI ç”Ÿæˆæ–¹æ¡ˆ", type="primary")

# --- 4. æ ¸å¿ƒé€»è¾‘ï¼šå®šä¹‰ AI çš„å¤§è„‘ (System Prompt) ---
# è¿™å°±æ˜¯æ‚¨â€œæŠ•å–‚â€ç»™ä»–çš„ç¬¬ä¸€æ‰¹æ ¸å¿ƒæŒ‡ä»¤
system_prompt = """
ä½ æ˜¯ä¸€ä½æ‹¥æœ‰20å¹´ç»éªŒçš„èµ„æ·±è‹±è¯­æ•™ç ”ä¸»ç®¡ã€‚ä½ çš„æ•™è‚²ç†å¿µåŸºäºâ€œäºŒè¯­ä¹ å¾—ç†è®º(SLA)â€å’Œâ€œæ”¯æ¶å¼æ•™å­¦â€ã€‚
è¯·æ ¹æ®ç”¨æˆ·çš„è¾“å…¥ï¼Œç”Ÿæˆä¸€ä»½æå…·é’ˆå¯¹æ€§çš„ã€Šè‹±è¯­å­¦ä¹ è§„åˆ’ä¹¦ã€‹ã€‚

**ä½ çš„æ ¸å¿ƒé€»è¾‘åº“ï¼š**
1. å¹¼å„¿(3-6å²)ï¼šå¿…é¡»èµ°â€œæ„Ÿå®˜+å¬åŠ›â€è·¯çº¿ï¼Œç¦æ­¢èƒŒå•è¯æ‹¼å†™ã€‚
2. å°å­¦(7-12å²)ï¼šå¿…é¡»å…¼é¡¾â€œæ ¡å†…æˆç»©â€å’Œâ€œèƒ½åŠ›æ‹“å±•â€ï¼Œå¼ºè°ƒæ—¶é—´æ•ˆç‡ã€‚
3. é›¶åŸºç¡€/å·®ç”Ÿï¼šæ ¸å¿ƒç­–ç•¥æ˜¯â€œé™ç»´æ‰“å‡»â€å’Œâ€œä¿æŠ¤å…´è¶£â€ï¼Œä¸è¦æ¨èå¤ªéš¾çš„æ•™æã€‚
4. å›½é™…æ ¡/ç‰›å¨ƒï¼šæ ¸å¿ƒç­–ç•¥æ˜¯â€œåŸç‰ˆé˜…è¯»â€å’Œâ€œå­¦æœ¯å†™ä½œâ€ï¼Œæ‹’ç»ä½å¹¼å†…å®¹ã€‚

**è¾“å‡ºæ ¼å¼è¦æ±‚ï¼š**
è¯·ç”¨Markdownæ ¼å¼ï¼Œè¯­è¨€ä¸“ä¸šã€äº²åˆ‡ã€æœ‰æ„ŸæŸ“åŠ›ã€‚ç»“æ„å¦‚ä¸‹ï¼š
1. **æ·±åº¦è¯Šæ–­**ï¼šä¸€é’ˆè§è¡€åœ°æŒ‡å‡ºå­©å­ç›®å‰çš„é—®é¢˜ï¼ˆä¸è¦è¯´åºŸè¯ï¼‰ã€‚
2. **æ ¸å¿ƒç­–ç•¥**ï¼šç”¨ä¸€ä¸ªä¸“ä¸šçš„æ•™å­¦æœ¯è¯­ï¼ˆå¦‚â€œæ¯è¯­æµ¸æ¶¦æ³•â€ã€â€œä¸‰æ˜æ²»åé¦ˆæ³•â€ï¼‰æ¥æ¦‚æ‹¬ã€‚
3. **å‘¨è®¡åˆ’è¡¨**ï¼šæ ¹æ®å­©å­çš„æ—¶é—´ï¼ˆå¹¼å„¿å›­/å°å­¦ï¼‰ï¼Œåˆ¶å®šå…·ä½“çš„æ¯æ—¥å®‰æ’ã€‚
4. **æ¨èèµ„æº**ï¼šæ ¹æ®å­©å­æ°´å¹³æ¨è2æœ¬å…·ä½“çš„ä¹¦å’Œ1ä¸ªå…·ä½“çš„APP/åŠ¨ç”»ç‰‡ï¼ˆå¸¦ä¸Šç®€å•çš„ç†ç”±ï¼‰ã€‚
5. **å®¶é•¿é”¦å›Š**ï¼šç»™å®¶é•¿çš„ä¸€æ¡å…·ä½“çš„äº’åŠ¨å»ºè®®ï¼ˆè¯æœ¯æˆ–æ¸¸æˆï¼‰ã€‚
"""

# --- 5. ä¸»ç•Œé¢é€»è¾‘ ---
st.title("ğŸ“ AI è‹±è¯­ç§æ•™è§„åˆ’ä¹¦")
st.caption("Powered by DeepSeek-V3 | æ·±åº¦æ•™è‚²æ¨¡å‹")
st.markdown("---")

if generate_btn:
    if not client:
        st.error("âš ï¸ æœªæ£€æµ‹åˆ° API Keyï¼Œè¯·å…ˆåœ¨ Streamlit Cloud åå°é…ç½® DEEPSEEK_API_KEYã€‚")
    else:
        # ç»„åˆç”¨æˆ·çš„ Prompt
        user_prompt = f"""
        **å­¦ç”Ÿæ¡£æ¡ˆï¼š**
        - å¹´é¾„ï¼š{age}å²
        - å­¦æ®µï¼š{school_stage}
        - ç°çŠ¶æè¿°ï¼š{status_desc}
        
        è¯·ä¸ºè¿™ä¸ªå­©å­ç”Ÿæˆè¯¦ç»†è§„åˆ’ã€‚
        """
        
        # æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
        with st.spinner("ğŸ¤– AI æ­£åœ¨è°ƒå–æ•™ç ”åº“ï¼Œåˆ†æå­¦ç”Ÿæ¡£æ¡ˆ..."):
            try:
                # å‘ DeepSeek å‘é€è¯·æ±‚
                response = client.chat.completions.create(
                    model="deepseek-chat",
                    messages=[
                        {"role": "system", "content": system_prompt},
                        {"role": "user", "content": user_prompt},
                    ],
                    temperature=1.3, # ç¨å¾®é«˜ä¸€ç‚¹çš„åˆ›é€ æ€§
                    stream=False
                )
                
                # è·å– AI çš„å›å¤
                ai_content = response.choices[0].message.content
                
                # å±•ç¤ºç»“æœ
                st.markdown(ai_content)
                
                st.success("âœ… æ–¹æ¡ˆå·²ç”Ÿæˆï¼æ‚¨å¯ä»¥æˆªå›¾ä¿å­˜æˆ–è°ƒæ•´å·¦ä¾§ä¿¡æ¯é‡æ–°ç”Ÿæˆã€‚")
                
            except Exception as e:
                st.error(f"å‡ºé”™äº†ï¼š{e}")

else:
    st.info("ğŸ‘ˆ è¯·åœ¨å·¦ä¾§å¡«å†™ä¿¡æ¯ï¼Œç‚¹å‡»æŒ‰é’®ï¼ŒAI å°†ä¸ºæ‚¨å®æ—¶ç”Ÿæˆæ–¹æ¡ˆã€‚")
